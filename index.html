<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple host that loads a non-bundled plugin</title>
  <style>
    #mount>* {
      transform: scale(0.5);
      transform-origin: top left;
      width: 200%;
    }
  </style>
  <script type="module" src="./wam-host/wamHost.js"></script>
  <script type="module" src="./wam-plugin/wamPlugin.js"></script>
  <script>WebAudioControlsOptions = {
      useMidi: 1,
      preserveMidiLearn: 1,
    }</script>
  <script>
    function saveProject() {
      const wamPluginWCs = document.querySelectorAll("wam-plugin");
      wamPluginWCs.forEach((pluginWC, index) => {
        const samplerState = pluginWC.instance.audioNode.getState();
        samplerState.WebAudioControlsMidiLearn = pluginWC.instance.audioNode.WebAudioControlsMidiLearn;
        samplerState.apiKey = pluginWC.instance.audioNode.apiKey;
        samplerState.presets = pluginWC.instance.audioNode.presets;
        //localStorage.setItem(`samplerState${index}`, JSON.stringify(samplerState));
        sessionStorage.setItem(`samplerState${index}`, JSON.stringify(samplerState));
      });
    }

    function loadProject() {
      const wamPluginWCs = document.querySelectorAll("wam-plugin");
      wamPluginWCs.forEach((pluginWC, index) => {
        //const savedState = JSON.parse(localStorage.getItem(`samplerState${index}`));
        const savedState = JSON.parse(sessionStorage.getItem(`samplerState${index}`));
        if (savedState) {
          pluginWC.instance.audioNode.setState(savedState);
        }
      });
    }
  </script>
</head>

<body>
  <br>
  <button onclick="saveProject()">Save Project</button>
  <button onclick="loadProject()">Load Project</button>
  <button id="btn-start">Start</button>
  <button id="btn-note">Play a MIDI note</button>
  <button id="btnNotes">Send Note List</button>
  <button id="btnPattern">Add pattern to pianoroll</button>

  <!-- <wam-host>
    <wam-plugin id="sampler" src="./src/index.js"></wam-plugin>
  </wam-host> -->

  <main>
    <div id="mount"></div>
  </main>

  <script>
    class NoteExtension {
      constructor() {
        this.noteDefinitions = new Map()
        this.listeners = new Map()
        this.pluginMapping = new Map()
      }

      setNoteList(pluginId, notes) {
        console.log("setNoteList pluginId = " + pluginId + " notes =" + notes)
        if (notes) {
          this.noteDefinitions.set(pluginId, notes)
        } else {
          this.noteDefinitions.delete(pluginId)
        }
        this.sendNoteLists()
      }

      addListener(pluginId, callback) {
        console.log("pluginId = " + pluginId);
        if (callback) {
          this.listeners.set(pluginId, callback)
        } else {
          this.listeners.delete(pluginId)
        }
        this.sendNoteLists()
      }

      addMapping(destinationId, sourceIds) {
        if (sourceIds) {
          this.pluginMapping.set(destinationId, sourceIds)
        } else {
          this.pluginMapping.delete(destinationId)
        }
        this.sendNoteLists()
      }

      clearMapping() {
        this.pluginMapping.clear()
      }

      sendNoteLists() {
        console.log("sendNoteList")
        this.pluginMapping.forEach((sourceIds, destinationId) => {
          console.log("sourceId = " + sourceIds + " destinationId = " + destinationId)
          let callback = this.listeners.get(destinationId)
          if (callback) {
            let noteListId = sourceIds.find((id) => this.noteDefinitions.has(id))
            if (noteListId) {
              callback(this.noteDefinitions.get(noteListId))
            } else {
              callback(undefined)
            }
          }
        })
      }
    }

    class PatternExtension {

      constructor() {
        this.delegates = new Map()
      }

      setPatternDelegate(pluginId, delegate) {
        /* delegate is an object with methods : 
              getPatternList: () => PatternEntry[]
              createPattern: (id: string) => void
              deletePattern: (id: string) => void
              playPattern: (id: string | undefined) => void
              getPatternState: (id: string) => any
              setPatternState: (id: string, state: any) => any
        */

        if (delegate) {
          this.delegates.set(pluginId, delegate)
          console.log("### DANS setPatternDelegate plugin id = " + pluginId + "###")

        } else {
          this.delegates.delete(pluginId)
        }
      }

      getPatternViewDelegate(pluginId) {
        console.log("### This.delegate = " + this.delegates)
        return this.delegates.get(pluginId)
      }
    }

    const initExtensions = async () => {
      window.WAMExtensions = window.WAMExtensions || {};
      window.WAMExtensions.notes = new NoteExtension();
      window.WAMExtensions.patterns = new PatternExtension();
    }

    const mount = document.querySelector('#mount');

    const audioContext = new AudioContext();
    let pianoRollInstance, samplerInstance;

    (async () => {

      initExtensions();

      const { default: initializeWamHost } = await import("https://www.webaudiomodules.com/sdk/2.0.0-alpha.6/src/initializeWamHost.js");
      const [hostGroupId] = await initializeWamHost(audioContext);

      const { default: SamplerWAM } = await import('./src/index.js');
      samplerInstance = await SamplerWAM.createInstance(hostGroupId, audioContext);
      samplerInstance.audioNode.connect(audioContext.destination);

      const samplerDomNode = await samplerInstance.createGui();
      mount.appendChild(samplerDomNode);

      const { default: PianoRollWAM } = await import('https://www.webaudiomodules.com/community/plugins/burns-audio/pianoroll/index.js');
      pianoRollInstance = await PianoRollWAM.createInstance(hostGroupId, audioContext);
      pianoRollInstance.audioNode.connect(audioContext.destination);

      const pianoRollDomNode = await pianoRollInstance.createGui();
      mount.appendChild(pianoRollDomNode);

      pianoRollInstance.audioNode.connectEvents(samplerInstance.instanceId);
      samplerInstance.audioNode.connect(audioContext.destination);

      window.WAMExtensions.notes.addMapping(pianoRollInstance.audioNode.instanceId, [samplerInstance.instanceId]);

      const startButton = document.querySelector("#btn-start");
      startButton.onclick = () => {
        console.log(audioContext.state)
        if (audioContext.state !== "running") {
          audioContext.resume();
        }

        if (startButton.textContent === "Start") {
          pianoRollInstance.audioNode.scheduleEvents({
            type: 'wam-transport', data: {
              playing: true,
              timeSigDenominator: 4,
              timeSigNumerator: 4,
              currentBar: 0,
              currentBarStarted: audioContext.currentTime,
              tempo: 120
            }
          });
          startButton.textContent = "Stop";
        } else {

          pianoRollInstance.audioNode.scheduleEvents({
            type: 'wam-transport', data: {
              playing: false,
              timeSigDenominator: 4,
              timeSigNumerator: 4,
              currentBar: 0,
              currentBarStarted: audioContext.currentTime,
              tempo: 120
            }
          });
          startButton.textContent = "Start";
          audioContext.suspend();
        }
      }

      document.querySelector("#btn-note").onclick = () => {
        audioContext.resume();
        samplerInstance.audioNode.scheduleEvents({
          type: 'wam-midi',
          time: samplerInstance.audioNode.context.currentTime,
          data: {
            bytes: new Uint8Array([0x90, 74, 100])
          }
        });
        samplerInstance.audioNode.scheduleEvents({
          type: 'wam-midi',
          time: samplerInstance.audioNode.context.currentTime + 0.25,
          data: {
            bytes: new Uint8Array([0x80, 74, 100])
          }
        });
      }

      document.querySelector("#btnNotes").onclick = () => {
        if (!(window.WAMExtensions && window.WAMExtensions.notes)) {
          return
        }

        let notes = [

          {
            blackKey: false,
            name: "Kick",
            number: 60
          },
          {
            blackKey: false,
            name: "Snare",
            number: 61
          },
        ]
        notes = notes.sort((a, b) => a.number - b.number)

        window.WAMExtensions.notes.setNoteList(samplerInstance.instanceId, notes)
      }


      document.querySelector("#btnPattern").onclick = () => {
        if (!(window.WAMExtensions && window.WAMExtensions.patterns)) {
          return
        }

        const testPattern = {
          "length": 96,
          "notes": [
            {
              "tick": 0,
              "number": 57,
              "duration": 6,
              "velocity": 100
            },
            {
              "tick": 12,
              "number": 58,
              "duration": 6,
              "velocity": 100
            },
            {
              "tick": 30,
              "number": 62,
              "duration": 6,
              "velocity": 100
            },
            {
              "tick": 36,
              "number": 58,
              "duration": 12,
              "velocity": 100
            },
            {
              "tick": 36,
              "number": 60,
              "duration": 6,
              "velocity": 100
            },
            {
              "tick": 48,
              "number": 56,
              "duration": 6,
              "velocity": 100
            },
            {
              "tick": 60,
              "number": 61,
              "duration": 18,
              "velocity": 100
            },
            {
              "tick": 72,
              "number": 54,
              "duration": 6,
              "velocity": 100
            }
          ]
        }

        console.log("PianoRoll instance iD = " + pianoRollInstance.audioNode.instanceId)
        const delegatePianoRoll = window.WAMExtensions.patterns.getPatternViewDelegate(pianoRollInstance.audioNode.instanceId);
        delegatePianoRoll.setPatternState("default", testPattern);
      }
    })();
  </script>
</body>

</html>